<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Future Designz - Secure System</title>
    <style>
        :root {
            --primary: #667eea; --secondary: #764ba2; --success: #28a745;
            --danger: #dc3545; --warning: #ffc107; --dark: #2d3436;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; color: #333; }

        .top-nav {
            position: sticky; top: 0; z-index: 1000; background: white; padding: 12px 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;
            border-bottom: 4px solid var(--secondary);
        }

        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex; justify-content: center; align-items: center; z-index: 10000;
        }
        .login-box { background: white; padding: 40px; border-radius: 15px; text-align: center; width: 90%; max-width: 400px; }
        .login-box input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ddd; border-radius: 8px; outline: none; user-select: auto; }

        .container { padding: 20px; display: none; }
        .logo { width: 120px; height: auto; pointer-events: none; }
        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .btn { padding: 10px 15px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; color: white; display: flex; align-items: center; gap: 5px; font-size: 13px; transition: 0.3s; }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: var(--primary); } 
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); } 
        .btn-warning { background: var(--warning); color: #333; }
        .btn-dark { background: var(--dark); }

        .table-card { background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; margin-bottom: 30px; }
        .table-wrapper { overflow-x: auto; max-height: 75vh; }
        table { width: 100%; border-collapse: collapse; font-size: 10px; }
        th { background: var(--secondary); color: white; padding: 10px 2px; position: sticky; top: 0; z-index: 20; border: 1px solid rgba(255,255,255,0.1); }
        td { border: 1px solid #eee; text-align: center; height: 115px; min-width: 105px; position: relative; }
        
        .emp-col { 
            position: sticky; left: 0; background: #fff !important; z-index: 30; 
            width: 165px; font-weight: bold; text-align: left; padding-left: 10px;
            border-right: 3px solid var(--secondary);
        }
        .sunday-col { background-color: #fff0f0 !important; color: #d63031; }

        .status-select { width: 95%; padding: 3px; border-radius: 4px; font-weight: bold; font-size: 10px; border: 1px solid #ccc; cursor: pointer; }
        .status-select:disabled, .time-input:disabled { background: #f1f2f6 !important; cursor: not-allowed; opacity: 0.7; }
        .time-input { font-size: 9px; width: 95%; border: 1px solid #eee; margin-top: 2px; padding: 2px; cursor: pointer; user-select: auto; }
        .total-time-display { font-size: 9px; font-weight: bold; color: #764ba2; margin-top: 3px; display: block; }

        .remark-btn { 
            position: absolute; top: 4px; right: 4px; background: #ffeb3b; border-radius: 50%; 
            width: 18px; height: 18px; font-size: 11px; cursor: pointer; border: 1px solid #c9bc1f; 
            display: flex; align-items: center; justify-content: center; z-index: 5;
        }

        .summary-section { margin-top: 40px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .summary-table { width: 100%; font-size: 13px; margin-top: 15px; border-collapse: collapse; }
        .summary-table th, .summary-table td { border: 1px solid #eee; padding: 12px; text-align: center; }

        #passModal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 25px; border-radius: 12px; z-index: 10001; width: 340px;
            box-shadow: 0 0 50px rgba(0,0,0,0.4);
        }

        .bulk-p-box { background: #eee; padding: 5px; border-radius: 5px; display: flex; gap: 5px; align-items: center; }
        input[type="number"] { user-select: auto; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="loginOverlay">
        <div class="login-box">
            <img src="https://futuredesignz.com/wp-content/uploads/2022/12/future-designs-logo1.webp" class="logo">
            <h2 style="margin: 15px 0;">Internal Secure Login</h2>
            <input type="password" id="passInput" placeholder="Access Key">
            <button class="btn btn-primary" style="width:100%; justify-content:center;" onclick="verifyAccess()">Unlock System</button>
        </div>
    </div>

    <div class="top-nav" id="topNav" style="display:none;">
        <div style="display:flex; align-items:center; gap:10px;">
            <img src="https://futuredesignz.com/wp-content/uploads/2022/12/future-designs-logo1.webp" class="logo">
            <select id="monthSelect" onchange="buildTable()"></select>
            <select id="yearSelect" onchange="buildTable()"></select>
            <div class="bulk-p-box">
                <input type="number" id="bulkDay" placeholder="Day" style="width:45px; padding:4px;">
                <button class="btn btn-success" style="padding:5px 10px;" onclick="bulkMarkP()">Bulk P</button>
            </div>
        </div>
        <div class="btn-group">
            <button class="btn btn-primary" onclick="addEmployee()">‚ûï Add Staff</button>
            <button class="btn btn-danger" onclick="removeEmployee()">‚ûñ Remove Staff</button>
            <button class="btn btn-success" onclick="exportExcelCSV()">üìä CSV</button>
            <button class="btn btn-warning" onclick="window.print()">üñ®Ô∏è Print</button>
            <button class="btn btn-dark" onclick="togglePassModal()">‚öôÔ∏è Settings</button>
            <button class="btn btn-danger" onclick="resetTable()">üóëÔ∏è Reset</button>
        </div>
    </div>

    <div class="container" id="mainApp">
        <div style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:12px;">
            <h2 style="color:var(--secondary)">Internal Attendance Portal</h2>
            <p id="adminTag" style="color: #28a745; font-weight: bold; font-size: 13px; display: none;">üõ°Ô∏è ADMIN MODE</p>
        </div>

        <div class="table-card">
            <div class="table-wrapper">
                <table id="attendanceTable">
                    <thead><tr id="headerRow"></tr></thead>
                    <tbody id="bodyRows"></tbody>
                </table>
            </div>
        </div>

        <div class="summary-section">
            <h3>Monthly Activity Summary</h3>
            <table class="summary-table">
                <thead>
                    <tr><th>Name</th><th>P</th><th>A</th><th>L</th><th>S</th><th>Total Hours</th></tr>
                </thead>
                <tbody id="summaryRows"></tbody>
            </table>
        </div>
    </div>

    <div id="passModal">
        <h3>System Settings</h3><br>
        <p style="font-size: 11px;">Update User Password:</p>
        <input type="text" id="newSecondaryPass" style="width:100%; padding:10px; margin:10px 0; border:1px solid #ccc; border-radius:5px;">
        <div style="display:flex; gap:10px;">
            <button class="btn btn-success" style="flex:1; justify-content:center;" onclick="saveNewPass()">Update</button>
            <button class="btn btn-danger" style="flex:1; justify-content:center;" onclick="togglePassModal()">Cancel</button>
        </div>
    </div>

    <script>
        // Encoded Master Key
        const _mKey = "SGFtemEwMzI3QEAA"; 
        let employees = JSON.parse(localStorage.getItem('fd_emp_list')) || ['Shehroz Sab', 'Uzair Sab', 'Ehsan', 'Waseem Sab', 'Faran Miss', 'Zunaira Miss', 'Sameer', 'Kabeer', 'Adnan Mughal', 'Waris Ali', 'Faroq Sab', 'Haroon Sab', 'Ahmad Cleaner', 'Ameer Hamza', 'Khalil Office boy'];
        let isAdmin = false;

        // Block Keyboard Shortcuts for Inspection
        document.onkeydown = function(e) {
            if(e.keyCode == 123 || (e.ctrlKey && e.shiftKey && (e.keyCode == 'I'.charCodeAt(0) || e.keyCode == 'J'.charCodeAt(0))) || (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0))) {
                return false;
            }
        };

        function verifyAccess() {
            const input = document.getElementById('passInput').value;
            const master = atob(_mKey);
            const secondary = localStorage.getItem('_fd_secure_ptr') ? atob(localStorage.getItem('_fd_secure_ptr')) : 'fd.7878';

            if(input === master || input === secondary) {
                if(input === master) { isAdmin = true; document.getElementById('adminTag').style.display = 'block'; }
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('topNav').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'block';
                initApp();
            } else { alert("Access Denied!"); }
        }

        function initApp() {
            const mSelect = document.getElementById('monthSelect');
            const ySelect = document.getElementById('yearSelect');
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            mSelect.innerHTML = "";
            months.forEach((m, i) => mSelect.add(new Option(m, i)));
            ySelect.innerHTML = "";
            for(let y = 2024; y <= 2027; y++) ySelect.add(new Option(y, y));
            const now = new Date();
            mSelect.value = now.getMonth(); ySelect.value = now.getFullYear();
            buildTable();
        }

        function buildTable() {
            const month = document.getElementById('monthSelect').value;
            const year = document.getElementById('yearSelect').value;
            const daysInMonth = new Date(year, parseInt(month) + 1, 0).getDate();
            const key = `fd_data_enc_v2_${year}_${month}`;
            const savedData = JSON.parse(localStorage.getItem(key)) || [];
            
            let header = '<th class="emp-col">Staff Member</th>';
            for(let d = 1; d <= daysInMonth; d++) header += `<th>${d}</th>`;
            document.getElementById('headerRow').innerHTML = header;

            const body = document.getElementById('bodyRows');
            body.innerHTML = employees.map((name, idx) => {
                const rowSaved = savedData[idx] || [];
                return `<tr>
                    <td class="emp-col">${name}</td>
                    ${Array.from({length: daysInMonth}, (_, i) => {
                        const cell = rowSaved[i] || {s:"", in:"", out:"", note:"", sL: false, inL: false, outL: false};
                        return `<td>
                            <div class="cell-container">
                                ${cell.note ? `<div class="remark-btn" onclick="alert('Note: ${cell.note}')">üìù</div>` : ''}
                                <select class="status-select" ${cell.sL && !isAdmin ? 'disabled' : ''} onchange="updateCell(${idx}, ${i}, 's', this.value)" style="background-color:${getStatusColor(cell.s)}">
                                    <option value="">-</option><option value="P" ${cell.s=='P'?'selected':''}>P</option>
                                    <option value="A" ${cell.s=='A'?'selected':''}>A</option><option value="L" ${cell.s=='L'?'selected':''}>L</option>
                                    <option value="S" ${cell.s=='S'?'selected':''}>S</option>
                                </select>
                                <input type="time" class="time-input" value="${cell.in}" ${cell.inL && !isAdmin ? 'disabled' : ''} onchange="updateCell(${idx}, ${i}, 'in', this.value)">
                                <input type="time" class="time-input" value="${cell.out}" ${cell.outL && !isAdmin ? 'disabled' : ''} onchange="updateCell(${idx}, ${i}, 'out', this.value)">
                                <span class="total-time-display">${calculateDiff(cell.in, cell.out)}h</span>
                            </div>
                        </td>`;
                    }).join('')}
                </tr>`;
            }).join('');
            updateSummary();
        }

        function updateCell(empIdx, dayIdx, field, value) {
            const key = `fd_data_enc_v2_${document.getElementById('yearSelect').value}_${document.getElementById('monthSelect').value}`;
            let data = JSON.parse(localStorage.getItem(key)) || [];
            if(!data[empIdx]) data[empIdx] = [];
            if(!data[empIdx][dayIdx]) data[empIdx][dayIdx] = {s:"", in:"", out:"", note:"", sL: false, inL: false, outL: false};

            let cell = data[empIdx][dayIdx];
            if(field === 's') { cell.s = value; if(value !== "") cell.sL = true; if(value === 'L' || value === 'S') cell.note = prompt("Enter Remark:"); }
            if(field === 'in') { cell.in = value; if(value !== "") cell.inL = true; }
            if(field === 'out') { cell.out = value; if(value !== "") cell.outL = true; }

            localStorage.setItem(key, JSON.stringify(data));
            buildTable();
        }

        function bulkMarkP() {
            const day = parseInt(document.getElementById('bulkDay').value);
            if(!day) return alert("Enter Day Number");
            const key = `fd_data_enc_v2_${document.getElementById('yearSelect').value}_${document.getElementById('monthSelect').value}`;
            let data = JSON.parse(localStorage.getItem(key)) || [];
            employees.forEach((_, idx) => {
                if(!data[idx]) data[idx] = [];
                if(!data[idx][day-1]) data[idx][day-1] = {s:"", in:"", out:"", note:"", sL: false, inL: false, outL: false};
                if(!data[idx][day-1].sL || isAdmin) { data[idx][day-1].s = "P"; data[idx][day-1].sL = true; }
            });
            localStorage.setItem(key, JSON.stringify(data));
            buildTable();
        }

        function calculateDiff(start, end) {
            if(!start || !end) return "0";
            let diff = (new Date(`2000-01-01T${end}`) - new Date(`2000-01-01T${start}`)) / 3600000;
            return diff < 0 ? (diff + 24).toFixed(1) : diff.toFixed(1);
        }

        function updateSummary() {
            const key = `fd_data_enc_v2_${document.getElementById('yearSelect').value}_${document.getElementById('monthSelect').value}`;
            const data = JSON.parse(localStorage.getItem(key)) || [];
            let html = "";
            employees.forEach((name, idx) => {
                let p=0, a=0, l=0, s=0, hrs=0;
                const row = data[idx] || [];
                row.forEach(cell => {
                    if(cell.s==='P') p++; if(cell.s==='A') a++; if(cell.s==='L') l++; if(cell.s==='S') s++;
                    hrs += parseFloat(calculateDiff(cell.in, cell.out));
                });
                html += `<tr><td style="text-align:left;">${name}</td><td>${p}</td><td>${a}</td><td>${l}</td><td>${s}</td><td>${hrs.toFixed(1)}</td></tr>`;
            });
            document.getElementById('summaryRows').innerHTML = html;
        }

        function getStatusColor(v) {
            const map = {'P':'#d4edda','A':'#f8d7da','L':'#fff3cd','S':'#e1f5fe'};
            return map[v] || 'white';
        }

        function addEmployee() { 
            let n = prompt("Enter New Staff Name:"); 
            if(n) { employees.push(n); localStorage.setItem('fd_emp_list', JSON.stringify(employees)); buildTable(); } 
        }

        function removeEmployee() { 
            let n = prompt("Enter Staff Name to Remove:"); 
            let i = employees.indexOf(n);
            if(i > -1) { employees.splice(i, 1); localStorage.setItem('fd_emp_list', JSON.stringify(employees)); buildTable(); } 
            else { alert("Name not found!"); }
        }

        function togglePassModal() { document.getElementById('passModal').style.display = (document.getElementById('passModal').style.display === 'block' ? 'none' : 'block'); }
        
        function saveNewPass() { 
            const p = document.getElementById('newSecondaryPass').value;
            if(p) { localStorage.setItem('_fd_secure_ptr', btoa(p)); alert("Password Updated"); togglePassModal(); }
        }

        function resetTable() {
            if(!isAdmin) return alert("Admin Only");
            if(confirm("Confirm: Reset all data for this month?")) {
                localStorage.removeItem(`fd_data_enc_v2_${document.getElementById('yearSelect').value}_${document.getElementById('monthSelect').value}`);
                buildTable();
            }
        }

        function exportExcelCSV() {
            let csv = "Name,P,A,L,S,Total Hours\n";
            document.querySelectorAll('#summaryRows tr').forEach(tr => {
                csv += Array.from(tr.querySelectorAll('td')).map(td => `"${td.innerText}"`).join(",") + "\n";
            });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
            link.download = `Attendance_Log_${new Date().toLocaleDateString()}.csv`;
            link.click();
        }
    </script>
</body>
</html>
